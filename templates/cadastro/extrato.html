<html lang="pt-br" >
<head>
    <title>CSA Barbetta</title>
    <link rel="stylesheet" type="text/css" href="/static/admin/css/base.css">
    <link rel="stylesheet" type="text/css" href="/static/admin/css/dashboard.css">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/admin/css/responsive.css">
    <meta name="robots" content="NONE,NOARCHIVE">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.js"></script>

    <style media="screen">
    @media only screen and (max-width: 600px) {
        #container {width: 100%;}
    }
    ul.object-tools {float:none;position:relative;margin-top:0;clear:both;}

    .status_filtro {
        font-size: 0.8em;
        color: #555;
        padding-top: 1.33em;
        padding-left: 0.5em;
        clear: both;
    }
    .status_filtro .pos {color: blue;}
    .status_filtro .neg {color: red;}

    </style>

    <script type="text/javascript">
        function getMoney( str ){
            return parseInt( str.replace(/[\D]+/g,'') );
        }

        function formatReal( int ){
            var tmp = int+'';
            tmp = tmp.replace(/([0-9]{2})$/g, ",$1");
            if( tmp.length > 6 )
                if(int>=0){
                    tmp = tmp.replace(/([0-9]{3}),([0-9]{2}$)/g, ".$1,$2");
                } else {
                    tmp = tmp.replace(/([0-9]{3}),([0-9]{2}$)/g, "$1,$2");
                }

            return tmp;
        }

        $(document).ready(function(){
            qtde_meses = {{qtde_meses}};
            json_qtde_por_cesta = {{json_qtde_por_cesta|safe}};

            $(".pagamentos").each(function(k, v){
                versao = $(this).attr("rel");
                total = 0
                $(this).find("td.pagamentos_registro").each(function(k,v){
                    parcial = parseInt( $(v).text().replace(',','') )
                    total += parcial;
                });
                $tab_cesta = $("#"+versao)
                valor_cesta = parseInt($($tab_cesta.find(".devido_cesta")[0]).text().replace(',',''));
                multiplicador = json_qtde_por_cesta[ $($tab_cesta.find(".devido_cesta")[0]).attr("rel") ]
                total_devido_cesta = multiplicador * valor_cesta;

                $(this).find("td.pagamentos_total").text(formatReal(total));
                $(this).find("td.devido_total").text(formatReal(total_devido_cesta));
                diff = total - total_devido_cesta
                $(this).find("td.diferenca").text(diff==0 ? "0,00" : formatReal(diff));
            })

            $("#todos").click(function(){
                $(".divcoag").show();
                $(".status_filtro").text("Mostrando todos os registros (" + $(".divcoag").length + ")");
            });

            $("#negativos").click(function(){
                cont = 0
                $(".divcoag").each(function(){
                    $id = $(this).attr("id");
                    diferenca = $(this).find(".diferenca").text();
                    diferenca = parseFloat(diferenca.replace(',', '.'));
                    console.log($id, diferenca);
                    if(diferenca < 0) {
                        $(this).show();
                        cont++;
                    } else {
                        $(this).hide();
                    }
                });
                $(".status_filtro").html("Mostrando registros com <span class='neg'>saldo negativo</span> (" + cont + ")");
            })

            $("#positivos").click(function(){
                cont = 0
                $(".divcoag").each(function(){
                    $id = $(this).attr("id");
                    diferenca = $(this).find(".diferenca").text();
                    diferenca = parseFloat(diferenca.replace(',', '.'));
                    console.log($id, diferenca);
                    if(diferenca > 0) {
                        $(this).show();
                        cont++;
                    } else {
                        $(this).hide();
                    }
                });
                $(".status_filtro").html("Mostrando registros com <span class='pos'>saldo positivo</span> (" + cont + ")");
            })

            $(".status_filtro").text("Mostrando todos os registros (" + $(".divcoag").length + ")");
        });
    </script>
</head>

<body class=" dashboard" data-admin-utc-offset="-10800">
<!-- Container -->
<div id="container">
    <!-- Header -->
    <div id="header">
        <div id="branding">
            <h1 id="site-name"><a href="/admin/">CSA Barbetta - Extrato de Pagamentos</a></h1>
        </div>
    </div>
    <!-- END Header -->

    <!-- Content -->
    <div id="content">
        <div>
            <h1>Extrato - {{ciclo_atual}}</h1>

            <ul class="object-tools">
                <li><a href="#" id="todos" class="historylink">Todos</a></li>
                <li><a href="#" id="negativos" class="historylink">Negativos</a></li>
                <li><a href="#" id="positivos" class="historylink">Positivos</a></li>
            </ul>

            <div class="status_filtro">
                Mostrando todos os coagricultores
            </div>

            {% for coag in lista_coag %}
                <div class="divcoag" id="divcoag_{{ coag.coagricultor.identificador }}">
                    <h2>{{coag.coagricultor.nome}}</h2>
                    {% for cesta_do_mes in coag.get_itens.all %}
                        {% ifchanged %}
                            <h3>Cesta Versão {{cesta_do_mes.cesta.versao}}</h3>
                            <table style="width:100%;" id="cesta_{{coag.coagricultor.identificador}}_{{cesta_do_mes.cesta.versao}}">
                                <head>
                                    <tr><th>Produto</th><th style="text-align:right;">Valor</th></tr>
                                </head>
                                <body>
                                {% for prod in cesta_do_mes.cesta.get_itens.all %}
                                    <tr><td>{{prod}}</td><td style="text-align:right;">{{prod.produto.valor}}</td></tr>
                                {% endfor %}
                                    <tr style="font-weight:bold;background-color:#EEEEFF">
                                        <td>Total Cesta:</td>
                                        <td style="text-align:right;" class="devido_cesta" rel="{{coag.coagricultor.identificador}}_{{cesta_do_mes.cesta.versao}}">{{cesta_do_mes.cesta.get_valor_total_no_ciclo}}</td>
                                    </tr>
                                </body>
                            </table>
                            <h3>Pagamentos</h3>
                            <table style="width:100%;" class="pagamentos" rel="cesta_{{coag.coagricultor.identificador}}_{{cesta_do_mes.cesta.versao}}">
                                <head>
                                    <tr><th>Data</th><th style="text-align:right;">Valor</th></tr>
                                </head>
                                <body>
                                {% for reg in cesta_do_mes.cesta.get_registros_financeiros.all %}
                                    <tr><td>{{reg.posicao}}</td><td style="text-align:right;" class="pagamentos_registro">{{reg.valor}}</td></tr>
                                {% endfor %}
                                    <tr style="font-weight:bold;background-color:#EEEEFF"><td>Total Devido:</td><td style="text-align:right;" class="devido_total"></td></tr>
                                    <tr style="font-weight:bold;background-color:#DDFFDD"><td>Total Pago:</td><td style="text-align:right;" class="pagamentos_total"></td></tr>
                                    <tr style="font-weight:bold;background-color:#FFDDDD"><td>Diferença:</td><td style="text-align:right;" class="diferenca"></td></tr>
                                </body>
                            </table>
                        {% endifchanged %}
                    {% endfor %}
                    <hr style="margin-top:30px;" />
                </div>
            {% endfor %}

        </div>
        <br class="clear">
    </div>
    <!-- END Content -->
    <div id="footer"></div>
</div>
<!-- END Container -->
</body>
</html>
